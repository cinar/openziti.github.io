"use strict";(self.webpackChunkopen_ziti=self.webpackChunkopen_ziti||[]).push([[256],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>f});var i=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,i,n=function(e,t){if(null==e)return{};var r,i,n={},a=Object.keys(e);for(i=0;i<a.length;i++)r=a[i],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)r=a[i],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var o=i.createContext({}),s=function(e){var t=i.useContext(o),r=t;return e&&(r="function"==typeof e?e(t):c(c({},t),e)),r},u=function(e){var t=s(e.components);return i.createElement(o.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var r=e.components,n=e.mdxType,a=e.originalType,o=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=s(r),m=n,f=d["".concat(o,".").concat(m)]||d[m]||p[m]||a;return r?i.createElement(f,c(c({ref:t},u),{},{components:r})):i.createElement(f,c({ref:t},u))}));function f(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=r.length,c=new Array(a);c[0]=m;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l[d]="string"==typeof e?e:n,c[1]=l;for(var s=2;s<a;s++)c[s]=r[s];return i.createElement.apply(null,c)}return i.createElement.apply(null,r)}m.displayName="MDXCreateElement"},18674:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>o,contentTitle:()=>c,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>s});var i=r(87462),n=(r(67294),r(3905));const a={title:"Using Public CA Certificates",sidebar_label:"Public CA Certs",sidebar_position:50},c=void 0,l={unversionedId:"guides/alt-server-certs",id:"guides/alt-server-certs",title:"Using Public CA Certificates",description:"You can configure the Ziti controller and routers to present alternative server certificates to Edge clients. This is useful in a deployment scenario where the Edge clients use ephemeral identities that can not be preconfigured to trust a particular certificate authority (CA) and must rely on the OS trust bundle of CA certificates.",source:"@site/docs/guides/alt-server-certs.md",sourceDirName:"guides",slug:"/guides/alt-server-certs",permalink:"/docs/guides/alt-server-certs",draft:!1,editUrl:"https://github.com/openziti/ziti-doc/tree/main/docusaurus/docs/guides/alt-server-certs.md",tags:[],version:"current",sidebarPosition:50,frontMatter:{title:"Using Public CA Certificates",sidebar_label:"Public CA Certs",sidebar_position:50},sidebar:"docsSidebar",previous:{title:"Sidecar Proxy",permalink:"/docs/guides/kubernetes/workload-tunneling/kubernetes-sidecar"},next:{title:"Hardware Security Modules (HSM) - PKCS11",permalink:"/docs/guides/hsm/"}},o={},s=[{value:"Ziti Controller",id:"ziti-controller",level:2},{value:"Ziti Routers",id:"ziti-routers",level:2},{value:"Ziti Edge SDKs",id:"ziti-edge-sdks",level:2}],u={toc:s};function d(e){let{components:t,...r}=e;return(0,n.kt)("wrapper",(0,i.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"You can configure the Ziti controller and routers to present alternative server certificates to Edge clients. This is useful in a deployment scenario where the Edge clients use ephemeral identities that can not be preconfigured to trust a particular certificate authority (CA) and must rely on the OS trust bundle of CA certificates."),(0,n.kt)("p",null,"As a rule, Ziti Edge SDKs will insist that the server certificates they encounter are verifiable with the CA certificate bundle embedded in the identity configuration. If the CA bundle is absent, then the server certificates must be verifiable by the OS trust bundle. This means that it's necessary to configure all Ziti routers and the Ziti controller, and Ziti Edge SDKs in the same way, i.e., for alternative server certificates from a publicly-verifiable third-party CA like Let's Encrypt or with certificates that are verifiable with the trust bundle that the controller publishes, e.g., ",(0,n.kt)("inlineCode",{parentName:"p"},"https://ctrl.example.com:1280/.well-known/est/cacerts"),"."),(0,n.kt)("p",null,"The following sections cover configuring each of the three Ziti components that must be aligned with the decision to use alternative server certificates: controller, routers, and SDKs."),(0,n.kt)("h2",{id:"ziti-controller"},"Ziti Controller"),(0,n.kt)("p",null,"The main server certificate that needs to be configured for the Ziti controller is that of the client-management API's bind point in the ",(0,n.kt)("inlineCode",{parentName:"p"},"web")," section."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"web:\n  - name: client-management\n    bindPoints:\n      - interface: 0.0.0.0:1280\n        address: ctrl.example.com:1280\n    identity:\n      server_cert: /etc/letsencrypt/live/example.com/fullchain.pem\n      key: /etc/letsencrypt/live/example.com/privkey.pem\n      ca: /etc/pki/ca/example.com/certs/ca.pem  # required but unused\n      cert: /etc/pki/ca/example.com/certs/client1.pem  # required but unused\n")),(0,n.kt)("h2",{id:"ziti-routers"},"Ziti Routers"),(0,n.kt)("p",null,"The main server certificate that needs to be configured for all Ziti routers is that of the edge TLS binding. This is accomplished by adding an ",(0,n.kt)("inlineCode",{parentName:"p"},"alt_server_certs")," identity property."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"identity:\n  server_cert: /etc/pki/ca/example.com/certs/server1.pem\n  key: /etc/pki/ca/example.com/keys/key1.pem\n  cert: /etc/pki/ca/example.com/certs/client1.pem\n  ca: /etc/pki/ca/example.com/certs/ca.pem\n  alt_server_certs:\n    - server_cert: /etc/letsencrypt/live/example.com/fullchain.pem\n      server_key: /etc/letsencrypt/live/example.com/privkey.pem\n")),(0,n.kt)("p",null,"Crucially, when alternative server certificates are configured, the router will select a server certificate to present which x509 subject alternative name (SAN) matches the\nserver name indication (SNI) of the incoming request. For this reason, you must ensure that the primary and alternative certificates do not have colliding SANs. If you choose to configure alternative wildcard certificates, you may ensure a predictable server certificate selection by using a distinct DNS name for ",(0,n.kt)("inlineCode",{parentName:"p"},"listeners[binding=edge].options.advertise"),"."),(0,n.kt)("p",null,"For example, if you had initially configured your Ziti router to advertise an address of ",(0,n.kt)("inlineCode",{parentName:"p"},"router1.example.com:443")," then the Ziti PKI certainly issued a server certificate with a DNS SAN like ",(0,n.kt)("inlineCode",{parentName:"p"},"router1.example.com"),". If you later decide to use alternative server certificates, then you would need to advertise a different address like ",(0,n.kt)("inlineCode",{parentName:"p"},"router1pub.example.com:443"),". That way, when edge clients request a connection, they'll be presented with the expected server certificate."),(0,n.kt)("p",null,"If present, then it is also necessary to configure an alternative server certificate for the WebSocket binding."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"transport:\n  ws:\n    identity:\n      server_cert: /etc/letsencrypt/live/example.com/fullchain.pem\n      key: /etc/letsencrypt/live/example.com/privkey.pem\n      ca: /etc/pki/ca/example.com/certs/ca.pem  # required but unused\n      cert: /etc/pki/ca/example.com/certs/client1.pem  # required but unused\n")),(0,n.kt)("h2",{id:"ziti-edge-sdks"},"Ziti Edge SDKs"),(0,n.kt)("p",null,"You must configure the identities used by all Edge SDKs to align with the decision to configure alternative server certificates. All Edge SDKs recognize the JSON schema of a Ziti identity configuration."),(0,n.kt)("p",null,"There are two ways to configure the identity:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"create and enroll a new identity with the same roles"),(0,n.kt)("li",{parentName:"ol"},"edit the stored identity configuration to prune the ",(0,n.kt)("inlineCode",{parentName:"li"},"id.ca")," property")),(0,n.kt)("p",null,"After configuring alternative server certificates on the controller, all newly created identities will lack the ",(0,n.kt)("inlineCode",{parentName:"p"},"id.ca")," property. This is because the alternative server certificates are presumed to be third-party and publicly verifiable by the Edge clients' OS trust bundles, not the Ziti trust bundle. By removing the ",(0,n.kt)("inlineCode",{parentName:"p"},"id.ca")," property from the stored identity configuration, the Edge SDK will instead rely on the OS trust bundle."))}d.isMDXComponent=!0}}]);