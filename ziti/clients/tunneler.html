<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Tunnelers | Ziti </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Tunnelers | Ziti ">
    <meta name="generator" content="docfx 2.x">
    
    <link rel="shortcut icon" href="../../images/favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
    <!--span>this is text</span-->
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;0,700;1,400&amp;display=swap" rel="stylesheet">
    <meta name="google-site-verification" content="jfzf3259Xh6i82RehhnKg4aAsHd02v1MB-jP43wEqHI">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-THVRRJ3GLE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
  
      gtag('config', 'G-THVRRJ3GLE');
    </script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/ziti-logo-40.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div style="display: flex;">
                    <div class="form-group" style="valign: center;position: relative;">
                      <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                    </div>
                    <div style="position: relative">
                        &nbsp;
                    </div>
                    <div style="position: relative">
                        <a href="https://github.com/openziti">
                            <img src="../../images/github-white.svg" alt="Star us on GitHub" title="Star us on GitHub" height="34px">
                        </a>
                    </div>
                    <div style="position: relative">
                        <a href="https://openziti.discourse.group">
                            <img src="../../images/discourse_icon_halo.svg" alt="Start a conversation on Discourse" title="Start a conversation on Discourse" height="34px">
                        </a>
                    </div>
                    <div style="position: relative">
                        <a href="https://twitter.com/openziti">
                            <img src="../../images/twit.svg" alt="Follow us on Twitter" title="Follow us on Twitter" height="34px">
                        </a>
                    </div>
                    <div style="position: relative">
                        <a href="https://www.youtube.com/channel/UCAsrfQasdZmp2Gq07Ej_5cQ">
                            <img src="../../images/yt.svg" alt="Watch videos about OpenZiti" title="Watch videos about OpenZiti" height="34px">
                        </a>
                    </div>
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default" name="new">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
          <div style="display:flex; align-items: center; justify-content: center; flex-direction:row; position: relative; width: 100%; text-align: center;     background: rgb(0,104,247);
            background: linear-gradient(90deg, rgba(0,104,247,1) 0%, rgba(222,14,91,1) 100%);">
            <span style="margin-top: 5px; color: white; margin-right: 10px; height:25px">Star us on GitHub</span>
            <span style="margin-top: 5px;"><a class="github-button" href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star openziti/ziti on GitHub">Star</a></span>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="tunnelers">Tunnelers</h1>

<p>An OpenZiti Tunneler is purpose-built software designed to connect applications which are not Ziti-aware to the OpenZiti Network.</p>
<ul>
<li><a href="https://github.com/openziti/desktop-edge-win/releases/latest">Windows</a></li>
<li><a href="https://apps.apple.com/app/id1460484572">MacOS</a></li>
<li><a href="https://github.com/openziti/ziti-tunnel-sdk-c/releases/latest/">Linux</a></li>
<li><a href="https://apps.apple.com/app/id1460484353">iOS</a></li>
<li><a href="https://play.google.com/store/apps/details?id=org.openziti.mobile">Android</a></li>
</ul>
<p>Each tunneller operates similarly. The goal is to have the tunneler intercecpt traffic destined for Ziti
services and forward that traffic over the Ziti overlay instead of the underlay network.  There are two basic modes a
tunneler operate in: seamless and proxy. A seamless tunneler will transparently intercept traffic via IPv4 address or
DNS whereas a tunneler in proxy mode works as a proxy. Seamless mode is transparent to existing services and
applications. Proxy mode is not transparent at all. It requires applications to send traffic to the localhost proxy
specifically. This means when running in proxy mode it does not do any intercepting at all.</p>
<p>The OpenZiti project provides tunnellers for each major operating system.</p>
<h2 id="linux">Linux</h2>
<h3 id="the-tunneller-cli">The Tunneller CLI</h3>
<p><code>ziti-edge-tunnel</code> is the general purpose tunneller CLI and can also run as a systemd daemon. For the best overall experience, please use the preferred tunneller <code>ziti-edge-tunnel</code> described here.</p>
<p>The purpose of the tunneller is to configure host access. This means all users and all processes on the host will share the same level of access. This is accomplished by configuring the OS to have an on-board OpenZiti DNS nameserver and IP routes for authorized OpenZiti Services.</p>
<h3 id="installation-and-upgrade">Installation and Upgrade</h3>
<h4 id="installing-the-deb">Installing the DEB</h4>
<ol>
<li>Run the script below to import the signing key, add a package source to the list, update sources, and install ziti-edge-tunnel.</li>
<li>Install an enroll token JWT file or identity config JSON file in <code>/opt/openziti/etc/identities</code>.</li>
<li>Run <code>systemctl start ziti-edge-tunnel.service</code>. The service needs to be restarted if the contents of the identities directory change.</li>
</ol>
<h5 id="ubuntu-jammy-2204">Ubuntu Jammy 22.04</h5>
<pre><code class="lang-bash">curl -sSLf https://raw.githubusercontent.com/openziti/ziti-tunnel-sdk-c/main/package-repos.gpg \
| gpg --dearmor \
| sudo tee /usr/share/keyrings/openziti.gpg &gt; /dev/null
echo &#39;deb [signed-by=/usr/share/keyrings/openziti.gpg] https://packages.openziti.org/zitipax-openziti-deb-stable jammy main&#39; | sudo tee --append /etc/apt/sources.list
sudo apt update
sudo apt install ziti-edge-tunnel
</code></pre><h5 id="ubuntu-focal-2004-bionic-1804-xenial-1604-trusty-1404">Ubuntu Focal 20.04, Bionic 18.04, Xenial 16.04, Trusty 14.04</h5>
<p>The script is the same as Jammy for these older Ubuntu releases, but you must substitute the correct Ubuntu release code name e.g. &quot;focal&quot; in place of &quot;jammy&quot; in the apt sources file.</p>
<h5 id="debian-gnulinux">Debian GNU/Linux</h5>
<p>The script is the same as Ubuntu Jammy for Debian releases, but you should substitute the youngest Ubuntu release code name e.g. &quot;focal&quot; that is older than your release of Debian in place of &quot;jammy&quot; in the apt sources file. For simplicity&#39;s sake, the Ubuntu 18.04 &quot;bionic&quot; build is broadly compatible with modern Debian releases.</p>
<h4 id="installing-the-rpm">Installing the RPM</h4>
<ol>
<li>Create a repo file like <code>/etc/yum.repos.d/openziti.repo</code> matching the appropriate example below for your OS.</li>
<li>Run <code>yum update</code> to refresh your repodata cache. Optionally, you may wish to also install all available updates.</li>
<li>Run <code>yum install ziti-edge-tunnel</code> to install the RPM.</li>
<li>Install an enroll token JWT file or identity config JSON file in <code>/opt/openziti/etc/identities</code>.</li>
<li>Run <code>systemctl start ziti-edge-tunnel.service</code>. The service needs to be restarted if the contents of the identities directory change.</li>
</ol>
<h5 id="rhel-centos-and-rocky-linux">RHEL, CentOS, and Rocky Linux</h5>
<pre><code class="lang-ini">[OpenZiti]
name=OpenZiti
baseurl=https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat$releasever/$basearch
enabled=1
gpgcheck=0
gpgkey=https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat$releasever/$basearch/repodata/repomd.xml.key
repo_gpgcheck=1
</code></pre><h5 id="fedora">Fedora</h5>
<pre><code class="lang-ini">[OpenZiti]
name=OpenZiti
baseurl=https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat8/$basearch
enabled=1
gpgcheck=0
gpgkey=https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat8/$basearch/repodata/repomd.xml.key
repo_gpgcheck=1
</code></pre><h5 id="amazon-linux">Amazon Linux</h5>
<pre><code class="lang-ini">[OpenZiti]
name=OpenZiti
baseurl=https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat7/$basearch
enabled=1
gpgcheck=0
gpgkey=https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat7/$basearch/repodata/repomd.xml.key
repo_gpgcheck=1
</code></pre><h4 id="binary">Binary</h4>
<p><a href="https://github.com/openziti/ziti-tunnel-sdk-c/releases/latest/">The latest binary release</a> of <code>ziti-edge-tunnel</code> is distributed as an executable for amd64, arm, arm64 architectures. The upgrade procedure is identical to the installation procedure.</p>
<pre><code class="lang-bash"># shell script illustrating the steps to install or upgrade ziti-edge-tunnel
wget -q &quot;https://github.com/openziti/ziti-tunnel-sdk-c/releases/latest/download/ziti-edge-tunnel-Linux_$(uname -p).zip&quot; \
  &amp;&amp; unzip ./ziti-edge-tunnel-Linux_$(uname -p).zip \
  &amp;&amp; rm ./ziti-edge-tunnel-Linux_$(uname -p).zip \
  &amp;&amp; chmod -c +x ./ziti-edge-tunnel \
  &amp;&amp; ./ziti-edge-tunnel version
</code></pre><h5 id="enroll-before-you-run">Enroll Before You Run</h5>
<p>You will need the token file or its contents to enroll. Enrollment is the act of exchanging the token for an identity that is to be permanently installed in the filesystem.</p>
<p><a href="../identities/enrolling.html">Here&#39;s a link to the article about enrolling</a></p>
<h3 id="global-options">Global Options</h3>
<pre><code class="lang-bash"># Load a single identity.
--identity &lt;identity&gt;
</code></pre><pre><code class="lang-bash"># Load all identities in a dir, ignoring files with a .bak or .original filename suffix.
--identity-dir &lt;dir&gt;
</code></pre><pre><code class="lang-bash"># Set log level, higher is more verbose (default level 3 means INFO).
--verbose N
</code></pre><pre><code class="lang-bash"># Set service polling interval in seconds (default 10).
--refresh N
</code></pre><h3 id="run-mode"><code>run</code> Mode</h3>
<p><code>ziti-edge-tunnel run</code> provides a transparent proxy and nameserver. The nameserver may be configured to be authoritative (the default) or recursive with a command-line option. The OS is automatically configured to treat the nameserver as primary. You may inspect the resulting configuration with these commands.</p>
<pre><code class="lang-bash">resolvectl dns     # inspect the association of tun device and nameserver
resolvectl domain  # inspect the configuration of query routing domains
</code></pre><p>If any interfaces have a wildcard routing domain configured, <code>ziti-edge-tunnel</code> will also configure its tun with a wildcard routing domain. If no other interface has a wildcard routing domain configured, neither will the <code>ziti-edge-tunnel</code> tun.</p>
<pre><code class="lang-bash"># Specify the tun interface address and the subnet to which Service domain names are resolved (default 100.64.0.1/10). The nameserver address is always the tun interface address +1, default is 100.64.0.2.
--dns-ip-range &lt;ip range&gt;
</code></pre><h4 id="how-does-ziti-edge-tunnel-run-configure-nameservers">How does <code>ziti-edge-tunnel run</code> configure nameservers?</h4>
<p><code>ziti-edge-tunnel run</code> provides a built-in nameserver that will answer queries that exactly match authorized OpenZiti services&#39; intercept domain names, and will respond with a hard-fail <code>NXDOMAIN</code> code if the query does not match an authorized service.</p>
<p>You may enable DNS recursion by specifying an upstream nameserver to answer queries for other domain names that are not services&#39; intercept domain names: <code>ziti-edge-tunnel run --dns-upstream 208.67.222.222</code>.</p>
<p><code>ziti-edge-tunnel</code> uses the <code>libsystemd</code> D-Bus RPC client and will try to configure the OS&#39;s resolvers with <code>systemd-resolved</code>. If that&#39;s not possible for any reason then <code>ziti-edge-tunnel run</code> will fall back to shell commands like <code>resolvectl</code>. If <code>resolvectl</code> fails then <code>ziti-edge-tunnel run</code> will attempt to modify <code>/etc/resolv.conf</code> directly to install the built-in nameserver as the primary resolver.</p>
<p>If the DNS record exists it returns the answer and sets query status to <code>NO_ERROR</code>. If it does not exist then it sends the query to an upstream DNS server if configured. Otherwise, it sets the query status to <code>REFUSE</code>. This implies that the caller <em>should</em> keep trying to resolve the domain name with other nameservers.</p>
<h4 id="system-requirements-for-mode-run">System Requirements For Mode <code>run</code></h4>
<p><code>ziti-edge-tunnel run</code> requires elevated privileges for managing the <code>/dev/net/tun</code> device, running <code>resolvectl</code> to assign nameservers and domain routes to the tun interface, and running <code>ip route</code> to manage IP routes. This requires running as root because <code>setcaps</code> are not inherited in all of these cases, even when the inherit bit is set.</p>
<h3 id="run-host-mode"><code>run-host</code> Mode</h3>
<p><code>ziti-edge-tunnel run-host</code> is a mode for hosting (listening) for services which does provide service intercepts or DNS. Services configured for &#39;Bind&#39; will be hosted by the tunneller.</p>
<h4 id="system-requirements-for-mode-run-host">System Requirements For Mode <code>run-host</code></h4>
<p><code>ziti-edge-tunnel run-host</code> does not require elevated privileges or the above device or socket, only network egress to the servers for which it is hosting Services.</p>
<h3 id="specialized-tunneller-alternatives">Specialized Tunneller Alternatives</h3>
<p>There are also a couple of more specialized tunneling apps. Please use the preferred tunneller <code>ziti-edge-tunnel</code> described above if possible.</p>
<ol>
<li><code>ziti-tunnel</code> has the unique capability of an opaque, raw TCP proxy in addition to some redundant capabilities deprecated by the preferred, general purpose tunneller described above: <code>ziti-edge-tunnel</code>.</li>
<li><code>ziti-router</code> has an optional <code>ziti-tunnel</code> feature built-in that may be enabled when an Edge Router is first created.</li>
</ol>
<p>The configuration and behavior of these two tunneller alternatives are identical and so are discussed as one for the remainder of this article. The tunneller is capable of operating in transparent proxy (<code>tproxy</code>), opaque proxy (<code>proxy</code>), and host (<code>host</code>) modes, discussed immediately below.</p>
<h3 id="tproxy">tproxy</h3>
<p>Typically you will run <code>ziti-tunnel tproxy</code>. This is the transparent proxy mode that uses IPtables rules to intercept traffic intended for OpenZiti Services. In this mode <code>ziti-tunnel</code> will also serve as an OpenZiti nameserver. You must configure the OS with that nameserver as the primary resolver. The nameserver will only answer queries for which it is authoritative i.e. OpenZiti Services&#39; domain names, and so you will also need a secondary, recursive resolver.</p>
<pre><code class="lang-bash"># You must have the IPtables kernel module installed.
$ lsmod | grep ip_tables
ip_tables              32768  5 iptable_filter,iptable_security,iptable_raw,iptable_nat,iptable_mangle
</code></pre><p><code>ziti-tunnel</code> manipulates routing tables and IPtables rules when using the tproxy
intercept mode. The <code>NET_ADMIN</code> Linux capability is required for these actions. The
usage example here runs ziti-tunnel with sudo as a convenient way to gain
that privilege:</p>
<pre><code class="lang-bash">$ sudo ziti-tunnel --identity ziti.json tproxy
[   0.000]    INFO ziti/tunnel/intercept/tproxy.New: tproxy listening on 127.0.0.1:33355
[   0.010]    INFO ziti/tunnel/dns.NewDnsServer: starting dns server...
[   2.018]    INFO ziti/tunnel/dns.NewDnsServer: dns server running at 127.0.0.1:53
[   2.018]    INFO ziti/tunnel/dns.(*resolver).AddHostname: adding ziti-tunnel.resolver.test = 19.65.28.94 to resolver
[   2.033]    INFO ziti/tunnel/dns.(*resolver).RemoveHostname: removing ziti-tunnel.resolver.test from resolver
[   2.096]    INFO ziti/tunnel/cmd/ziti-tunnel/subcmd.updateServices: starting tunnel for newly available service wttr.in
[   2.290]    INFO ziti/tunnel/dns.(*resolver).AddHostname: adding wttr.in = 5.9.243.187 to resolver
[   2.300]    INFO ziti/tunnel/cmd/ziti-tunnel/subcmd.updateServices: service wttr.in not hostable
[   2.300]    INFO ziti/tunnel/cmd/ziti-tunnel/subcmd.updateServices: starting tunnel for newly available service ssh-local
[   2.570]    INFO ziti/tunnel/dns.(*resolver).AddHostname: adding local.io = 169.254.1.1 to resolver
</code></pre><p>The tproxy intercept mode creates a network listener that accepts connections at a
randomly selected port on the loopback interface. Intercepted ziti service traffic
directed to the listener by two mechanisms:</p>
<ul>
<li><p>Firewall Rules (iptables)</p>
<p>  The TPROXY iptables target is the primary intercept mechanism used by the tproxy
  intercept mode. The TPROXY target essentially sends packets to a local listener
  without actually modifying the packet&#39;s destination address fields. See
  <a href="https://www.kernel.org/doc/Documentation/networking/tproxy.txt">https://www.kernel.org/doc/Documentation/networking/tproxy.txt</a> and
  <code>iptables-extensions(8)</code> for more details on the TPROXY target.</p>
<p>  First, the tproxy interceptor links a new iptables chain to the PREROUTING chain:</p>
<pre><code class="lang-bash">$ sudo iptables -nt mangle -L PREROUTING | grep NF-INTERCEPT
NF-INTERCEPT  all  --  0.0.0.0/0            0.0.0.0/0
</code></pre><p>  Then it creates rules in the new chain for each intercepted service. You can view
  the tproxy rules in play:</p>
<pre><code class="lang-bash">$ sudo iptables -nt mangle -L NF-INTERCEPT
Chain NF-INTERCEPT (1 references)
target     prot opt source               destination         
TPROXY     tcp  --  0.0.0.0/0            5.9.243.187          /* wttr.in */ tcp dpt:443 TPROXY redirect 127.0.0.1:33355 mark 0x1/0x1
TPROXY     tcp  --  0.0.0.0/0            169.254.1.1          /* ssh-local */ tcp dpt:22 TPROXY redirect 127.0.0.1:33355 mark 0x1/0x1
TPROXY     tcp  --  0.0.0.0/0            1.2.3.4              /* netcat */ tcp dpt:22169 TPROXY redirect 127.0.0.1:33355 mark 0x1/0x1
</code></pre><p>  Packets with a destination address that matches the intercept address of a Ziti
  service are directed to ziti-tunnel&#39;s network listener (127.0.0.1:33355 in the
  examples above). This effectively enables <code>ziti-tunnel</code> to capture packets that
  are destined for any address using a single listener (and a single port).</p>
<p>  NOTE: <em>netfilter</em> rules were considered when implementing ziti-tunnel&#39;s tproxy
  intercept mode. <em>netfilter</em> is a slightly more modern than <em>iptables</em> and has
  a supported netlink API for manipulating rules without &quot;shelling out&quot; to the
  <code>iptables</code> command line utility. <em>netfilter</em> was ultimately abandoned because
  netfilter tproxy support requires kernel configuration options (<code>CONFIG_NFT_TPROXY</code>,
  <code>CONFIG_NFT_SOCKET</code>) that are not enabled in the default kernels of many common
  Linux distributions.</p>
</li>
<li><p>Local Routes</p>
<p>  The TPROXY target is only valid in the PREROUTING iptables chain, which is
  traversed by incoming packets that were routed to the host over the network. A
  <em>local</em> route is necessary in order to get locally generated packets to traverse
  the PREROUTING chain:</p>
<pre><code class="lang-bash">$ ip route show table local
local 1.2.3.4 dev lo proto kernel scope host src 1.2.3.4
local 5.9.243.187 dev lo proto kernel scope host src 5.9.243.187
local 169.254.1.1 dev lo proto kernel scope host src 169.254.1.1
</code></pre></li>
</ul>
<h3 id="tproxy-dns-nameserver">tproxy DNS nameserver</h3>
<p><em>Please use the preferred tunneller if possible. It is not necessary to manually configure DNS for the preferred tunneller</em></p>
<p><code>ziti-tunnel tproxy</code> mode runs a built-in nameserver serving on udp://127.0.0.1:53 by default, and configurable with a command-line option. The nameserver is authoritative for all authorized OpenZiti Services&#39; domain names. This nameserver must be primary in the host&#39;s resolver
configuration. A self-test is performed when ziti-tunnel starts to ensure that OpenZiti domains names are resolvable:</p>
<pre><code class="lang-log">INFO[0002] dns server started on 127.0.0.1:53           
INFO[0002] adding ziti-tunnel.resolver.test -&gt; 19.65.28.94 to resolver 
INFO[0002] removing ziti-tunnel.resolver.test from resolver 
</code></pre><p>The test involves inserting a known hostname/IP address into the internal DNS server, and using the system
resolver to retrieve the address of the hostname. <em>ziti-tunnel will exit if the DNS self-test fails.</em></p>
<p>Linux distributions typically manage the contents of /etc/resolv.conf, so simply editing the file
will only work for a short time until /etc/resolv.conf is overwritten by the managing process.</p>
<p>Resolver configuration changes must survive restarts of the Linux name resolution manager. Linux
distrubutions use one of several name resolution managers. The simplest way to determine which name
resolution manager is being used by your Linux distrubtion is to look at /etc/resolv.conf:</p>
<pre><code class="lang-bash">ls -l /etc/resolv.conf
</code></pre><ul>
<li>If /etc/resolv.conf is a regular file, then it is most likely being managed by <code>dhclient</code>.</li>
<li>If /etc/resolv.conf is a symlink to a file in /run/systemd/resolve, then it is being
managed by <code>systemd-resolved</code></li>
<li>If /etc/resolv.conf is a symlink at all it is being managed by some process on which the particular steps to configure the primary nameserver will depend.</li>
</ul>
<h3 id="dhclient">dhclient</h3>
<p><em>Please use the preferred tunneller if possible. It is not necessary to manually configure DNS for the preferred tunneller</em></p>
<p>If your Linux distribution uses dhclient, you can configure the system resolver to use
ziti-tunnel&#39;s internal DNS server first by adding the following to /etc/dhcp/dhclient.conf:</p>
<pre><code class="lang-conf">prepend domain-name-servers 127.0.0.1;
</code></pre><p>Then restart network manager. Unless you know the name of the NetworkManager systemd
service on your Linux distrubtion, it&#39;s probably easiest to reboot the host.</p>
<h3 id="systemd-resolved">systemd-resolved</h3>
<p><em>Please use the preferred tunneller if possible. It is not necessary to manually configure DNS for the preferred tunneller</em></p>
<pre><code class="lang-bash">sudo ln -sf /run/systemd/resolve/resolv.conf /etc
echo -e &quot;[Resolve]\nDNS=127.0.0.1&quot; | sudo tee /etc/systemd/resolved.conf.d/ziti-tunnel.conf
sudo systemctl restart systemd-resolved
</code></pre><p>If you are unable to control the resolver on your operating system, ziti-tunnel can use/update a hosts file for
any hostnames that it tunnels:</p>
<pre><code class="lang-bash">ziti-tunnel run --resolver file:///etc/hosts &quot;${HOME}/ziti.json&quot;
</code></pre><h3 id="ip-address-assignment">IP Address Assignment</h3>
<p>If the service specifies a hostname for its address, ziti-tunnel resolves the hostname and adds the result to its
internal DNS server:</p>
<pre><code class="lang-log">[0127]  INFO adding myservice.mydomain.com -&gt; 45.60.32.165 to resolver
</code></pre><p>If the service hostname does not resolve, ziti-tunnel will find an unused link-local address and assign it to
the route for the service:</p>
<pre><code class="lang-log">[0012]  INFO adding bogushost.net -&gt; 169.254.1.4 to resolver
[0012]  INFO ziti/tunnel/protocols/tcp.Listen: Accepting on 169.254.1.4:25 service=telnet
</code></pre><h3 id="proxy">proxy</h3>
<p>The proxy intercept mode creates a network listener for each Ziti service that is
intercepted. The services to intercept, and the ports that they are intercepted on,
are specified on the command line (as opposed to using the service definitions that
are retrieved from the Ziti Edge Controller):</p>
<pre><code>$ ziti-tunnel --identity ziti.json proxy wttr.in:8443 ssh-local:2222 netcat:22169
[   0.004]    INFO ziti/tunnel/intercept/proxy.(*proxyInterceptor).Start: starting proxy interceptor
[   0.120]    INFO ziti/tunnel/intercept.updateServices: starting tunnel for newly available service ssh-local
[   0.183]    INFO ziti/tunnel/intercept.updateServices: service ssh-local not hostable
[   0.183]    INFO ziti/tunnel/intercept.updateServices: starting tunnel for newly available service netcat
[   0.183]    INFO ziti/tunnel/intercept/proxy.proxyInterceptor.runServiceListener: {addr=[0.0.0.0:2222] service=[ssh-local]} service is listening
[   0.203]    INFO ziti/tunnel/intercept.updateServices: service netcat not hostable
[   0.203]    INFO ziti/tunnel/intercept/proxy.proxyInterceptor.runServiceListener: {addr=[0.0.0.0:22169] service=[netcat]} service is listening
[   0.203]    INFO ziti/tunnel/intercept.updateServices: starting tunnel for newly available service wttr.in
[   0.226]    INFO ziti/tunnel/intercept.updateServices: service wttr.in not hostable
[   0.226]    INFO ziti/tunnel/intercept/proxy.proxyInterceptor.runServiceListener: {addr=[0.0.0.0:8443] service=[wttr.in]} service is listening
</code></pre><p>All network listeners bind to local network interfaces (0.0.0.0):</p>
<pre><code>$ netstat -tnl | fgrep 0.0.0.0
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 0.0.0.0:2222            0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:22169           0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:8443            0.0.0.0:*               LISTEN     
</code></pre><h3 id="troubleshooting">Troubleshooting</h3>
<ul>
<li><p>The simplest step you can take toward a diagnosis is to reduce the minimum message log level. This usually means lower-level DEBUG messages and above are emitted in addition to the default level of INFO level and above e.g. WARN, ERROR, etc. </p>
<p>For <code>ziti-edge-tunnel</code>: DEBUG log level is <code>ziti-edge-tunnel --verbose=4</code></p>
<p>For the alternative tunnellers: DEBUG log level is like <code>ziti-tunnel --verbose</code></p>
</li>
<li><p>You may inspect the loaded identities&#39; info for a running <code>ziti-edge-tunnel</code> by dumping it to stdout or the systemd journal with an IPC command, or you may signal to dump the identities&#39; info to a file.</p>
<pre><code class="lang-bash"># dump indentities info to std our journal if systemd unit with IPC command
./ziti-edge-tunnel dump
</code></pre><pre><code class="lang-bash"># dump identities info to a file and inspect
sudo pkill -USR1 -f ziti-edge-tunnel
less /tmp/ziti-dump.964315.dump
</code></pre></li>
<li><p>If the tunneller is crashing then it may be crucial to collect and analyze the core dump file. You may need to enable saving core dumps depending upon your OS configuration. </p>
<p>You can see how dump files are handled by inspecting this file, which is from Ubuntu 20.10.</p>
<pre><code class="lang-bash">$ cat /proc/sys/kernel/core_pattern
|/usr/share/apport/apport %p %s %c %d %P %E
</code></pre><p>In this case the dump is handled by <code>apport</code> which saves the file in <code>/var/crash</code>. I&#39;ll need to follow the <code>apport</code> documentation to learn how to unpack and parse the dump file.</p>
</li>
</ul>
<h2 id="windows">Windows</h2>
<p>The Windows tunneler currently supports proxy mode and cannot yet seamlessly intercept IPv4 traffic/DNS requests. </p>
<p>The proxy intercept mode creates a network listener for each Ziti service that is
intercepted. The services to intercept, and the ports that they are intercepted on,
are specified on the command line (as opposed to using the service definitions that
are retrieved from the Ziti Edge Controller):</p>
<pre><code>$ ziti-tunnel --identity ziti.json proxy wttr.in:8443 ssh-local:2222 netcat:22169
[   0.004]    INFO ziti/tunnel/intercept/proxy.(*proxyInterceptor).Start: starting proxy interceptor
[   0.120]    INFO ziti/tunnel/intercept.updateServices: starting tunnel for newly available service ssh-local
[   0.183]    INFO ziti/tunnel/intercept.updateServices: service ssh-local not hostable
[   0.183]    INFO ziti/tunnel/intercept.updateServices: starting tunnel for newly available service netcat
[   0.183]    INFO ziti/tunnel/intercept/proxy.proxyInterceptor.runServiceListener: {addr=[0.0.0.0:2222] service=[ssh-local]} service is listening
[   0.203]    INFO ziti/tunnel/intercept.updateServices: service netcat not hostable
[   0.203]    INFO ziti/tunnel/intercept/proxy.proxyInterceptor.runServiceListener: {addr=[0.0.0.0:22169] service=[netcat]} service is listening
[   0.203]    INFO ziti/tunnel/intercept.updateServices: starting tunnel for newly available service wttr.in
[   0.226]    INFO ziti/tunnel/intercept.updateServices: service wttr.in not hostable
[   0.226]    INFO ziti/tunnel/intercept/proxy.proxyInterceptor.runServiceListener: {addr=[0.0.0.0:8443] service=[wttr.in]} service is listening
</code></pre><p>All network listeners bind to local network interfaces (0.0.0.0):</p>
<pre><code>$ netstat -tnl | fgrep 0.0.0.0
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 0.0.0.0:2222            0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:22169           0.0.0.0:*               LISTEN     
tcp        0      0 0.0.0.0:8443            0.0.0.0:*               LISTEN     
</code></pre><h2 id="android">Android</h2>
<p>The Android tunneler is currently in an open beta. Find the app in the <a href="https://play.google.com/store/apps/details?id=io.netfoundry.ziti.tunnel">Play store here</a>. The source code for <a href="https://github.com/openziti/ziti-tunnel-android/">the Android tunneler is in GitHub</a> and it is based on <a href="https://github.com/openziti/ziti-sdk-jvm">the SDK for the JVM</a>.</p>
<h2 id="ios">iOS</h2>
<p>The iOS tunneler is currently in preview. Find the app in the <a href="https://apps.apple.com/us/app/ziti-tunnel/id1460484353">Apple store here</a></p>
<h2 id="macos">MacOS</h2>
<p>The MacOS tunneler is currently in preview. Find the app in the <a href="https://apps.apple.com/us/app/ziti-tunnel/id1460484572?mt=12">Mac App Store</a></p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/openziti/ziti-doc/blob/master/docfx_project/ziti/clients/tunneler.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span class='pull-left'><span><a href='https://netfoundry.io'>©NetFoundry Inc.</a></span>&nbsp;&nbsp;<span><a href='https://www.netfoundry.io/privacy-policy'>Privacy Policy</a></span>&nbsp;&nbsp;<span><a href='https://www.netfoundry.io/legal-items'>Legal</a></span>&nbsp;&nbsp;<span><a href='https://netfoundry.zendesk.com/hc/en-us'>Support</a></span>&nbsp;&nbsp;</span><span class='pull-right'><span><a href='https://www.facebook.com/NetFoundry/' target='_blank'><img height='25' src='/images/fb.svg'></a></span>&nbsp;<span><a href='https://twitter.com/openziti' target='_blank'><img height='25' src='/images/twit.svg'></a></span>&nbsp;<span><a href='https://www.linkedin.com/company/netfoundry/' target='_blank'><img height='25' src='/images/li.svg'></a></span>&nbsp;<span><a href='https://www.youtube.com/channel/UCAsrfQasdZmp2Gq07Ej_5cQ' target='_blank'><img height='25' src='/images/yt.svg'></a></span>&nbsp;&nbsp;&nbsp;</span><br>
<!-- Place this tag in your head or just before your close body tag. -->
<script async="" defer="" src="https://buttons.github.io/buttons.js"></script>
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
