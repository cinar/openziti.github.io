<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Prometheus Endpoint | Ziti </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Prometheus Endpoint | Ziti ">
    <meta name="generator" content="docfx 2.x">
    
    <link rel="shortcut icon" href="../../images/favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
    <!--span>this is text</span-->
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;0,700;1,400&amp;display=swap" rel="stylesheet">
    <meta name="google-site-verification" content="jfzf3259Xh6i82RehhnKg4aAsHd02v1MB-jP43wEqHI">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-THVRRJ3GLE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
  
      gtag('config', 'G-THVRRJ3GLE');
    </script>
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/ziti-logo-40.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div style="display: flex;">
                    <div class="form-group" style="valign: center;position: relative;">
                      <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                    </div>
                    <div style="position: relative">
                        &nbsp;
                    </div>
                    <div style="position: relative">
                        <a href="https://github.com/openziti">
                            <img src="../../images/github-white.svg" alt="Star us on GitHub" title="Star us on GitHub" height="34px">
                        </a>
                    </div>
                    <div style="position: relative">
                        <a href="https://openziti.discourse.group">
                            <img src="../../images/discourse_icon_halo.svg" alt="Start a conversation on Discourse" title="Start a conversation on Discourse" height="34px">
                        </a>
                    </div>
                    <div style="position: relative">
                        <a href="https://twitter.com/openziti">
                            <img src="../../images/twit.svg" alt="Follow us on Twitter" title="Follow us on Twitter" height="34px">
                        </a>
                    </div>
                    <div style="position: relative">
                        <a href="https://www.youtube.com/channel/UCAsrfQasdZmp2Gq07Ej_5cQ">
                            <img src="../../images/yt.svg" alt="Watch videos about OpenZiti" title="Watch videos about OpenZiti" height="34px">
                        </a>
                    </div>
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default" name="new">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
          <div style="display:flex; align-items: center; justify-content: center; flex-direction:row; position: relative; width: 100%; text-align: center;     background: rgb(0,104,247);
            background: linear-gradient(90deg, rgba(0,104,247,1) 0%, rgba(222,14,91,1) 100%);">
            <span style="margin-top: 5px; color: white; margin-right: 10px; height:25px">Star us on GitHub</span>
            <span style="margin-top: 5px;"><a class="github-button" href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star openziti/ziti on GitHub">Star</a></span>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="prometheus-endpoint">Prometheus Endpoint</h1>

<p>The Ziti Controller can expose a <code>/metrics</code> endpoint that serves network metrics in the Prometheus <a href="https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format">text exposition format</a>. </p>
<p>The endpoint is exposed over HTTPS, and has optional support for client authentication via a certificate.</p>
<h2 id="ziti-configuration">Ziti Configuration</h2>
<p>The Prometheus metric binding is configured as part of the controller configuration file.</p>
<h3 id="binding">Binding</h3>
<p>The Prometheus metrics api is not bound to any interface by default. The metrics api can be bound to the same network interface and port as the other Ziti APIs, or it can be set up on its own interface and/or port.   </p>
<h4 id="listener-just-for-metrics">Listener Just for Metrics</h4>
<p>The metric api can be configured to listen on its own combination of network interface and port by adding a new section under the <code>web</code> configuration</p>
<pre><code>web
  # Binding for other Ziti APIs
  - name: apis
    bindPoints:
      - interface: 0.0.0.0:1280
        address: 0.0.0.0:1280
    options:
      idleTimeout: 5000ms  #http timeouts, new
      readTimeout: 5000ms
      writeTimeout: 100000ms
    apis:
      # binding - required
      # Specifies an API to bind to this webListener. Built-in APIs are
      #   - health-checks
      #   - edge-management
      #   - edge-client
      #   - fabric-management
      #   - metrics
      - binding: health-checks
        options: { }
      - binding: fabric
      - binding: edge-management
        # options - variable optional/required
        # This section is used to define values that are specified by the API they are associated with.
        # These settings are per API. The example below is for the `edge-api` and contains both optional values and
        # required values.
        options: { }
      - binding: edge-client
        options: { }

  # New binding for metrics
  - name: apis-metrics-localhost
    bindPoints:
      #interface - required
      # A host:port string on which network interface to listen on. 0.0.0.0 will listen on all interfaces
      - interface: 127.0.0.1:2112

        # address - required
        # The public address that external incoming requests will be able to resolve. Used in request processing and
        # response content that requires full host:port/path addresses.
        address: 127.0.0.1:2112
    options:
    apis:
      - binding: metrics
        options: { }
</code></pre><h4 id="add-metrics-api-to-an-existing-listener">Add Metrics API to an Existing Listener</h4>
<p>The metrics binding can be added to an existing listener in the controller. </p>
<pre><code>web
  -name: apis
   bindpoints:
   apis: 
      - binding: health-checks
        options: { }
      - binding: fabric
      - binding: edge-management
        options: { }
      - binding: edge-client
        options: { }
      - binding: metrics
        options: { }
</code></pre><h3 id="authentication">Authentication</h3>
<p>Authentication is done by adding a client certificate to the metrics binding.  The metrics endpoint will return a 401 if this certificate is not presented by clients when they connect.</p>
<p>The certificate is completely stand-alone - it does not need to be signed by Ziti.</p>
<p>The configuration is added as an option in the metrics binding.  The file must be an x509 certificate. </p>
<pre><code>     - binding: metrics
        options: {
          scrapeCert: &quot;/etc/prometheus/prom-client.crt&quot;
        }
</code></pre><h3 id="timestamps">Timestamps</h3>
<p>OpenZiti can export timestamps in the Prometheus metrics. These timestamps can be helpful to align metrics with application logs if there is any clock skew across the OpenZiti network.</p>
<p>Timestamps are disabled by default, and can be enabled by setting a the <code>includeTimestamps</code> option to <code>true</code> in the metrics binding:</p>
<pre><code>web
  -name: apis
   bindpoints:
   apis:
      - binding: health-checks
        options: { }
      - binding: fabric
      - binding: edge-management
        options: { }
      - binding: edge-client
        options: { }
      - binding: metrics
        options: {
          includeTimestamps: true
        }
</code></pre><div class="NOTE"><h5>Note</h5><p>Prometheus will silently discard metrics that are older than five minutes.</p>
</div>
<h3 id="prometheus-configuration">Prometheus Configuration</h3>
<h4 id="tls-configuration">TLS Configuration</h4>
<p>The <code>/metrics</code> api requires TLS configuration in Prometheus. The Prometheus scrape config must have the ziti web public key, or be configured to ignore private keys.</p>
<pre><code>  - job_name: ziti
    scheme: https
    metrics_path: /metrics
    honor_labels: true
    honor_timestamps: true
    tls_config:
      // Path to the cert file with the ziti public key
      ca_file: /etc/prometheus/server.crt
      // OR ignore the key 
      insecure_skip_verify: true
    static_configs:
      - targets:
        - &#39;127.0.0.1:2112&#39;
</code></pre><h4 id="with-authentication">With Authentication</h4>
<p>It&#39;s a good idea to have metrics protected by a certificate to prevent neferious actors from pulling metrics about your network.  The Prometheus scrape configuration can be configured with a keystore for this purpose:</p>
<pre><code> - job_name: ziti
    scheme: https
    metrics_path: /metrics
    honor_labels: true
    honor_timestamps: true
    tls_config:
      cert_file: /etc/prometheus/prom-client.crt
      key_file: /etc/prometheus/prom-client.key
      ca_file: /etc/prometheus/server.crt
    static_configs:
      - targets:
        - &#39;127.0.0.1:2112&#39;
</code></pre><h2 id="examples">Examples</h2>
<h3 id="setup-metrics-authentication">Setup Metrics Authentication</h3>
<p>In this example you will:</p>
<ol>
<li>Create a new cert and signing request</li>
<li>Sign the key</li>
<li>Add the key into your Ziti Controller configuration</li>
<li>Add the key to your prometheus scrape config</li>
</ol>
<h4 id="create-a-cert-for-metric-scraping">Create a cert for metric scraping</h4>
<pre><code># Create the certificate and signing request
openssl req  -new  -newkey rsa:2048  -nodes  -keyout prom-client.key  -out prom-client.csr

# Process the cert signing signing request.  This cert will be good for 10 years.
openssl  x509  -req  -days 3650 -in /tmp/prom-client.csr  -signkey prom-client.key  -out prom-client.crt 
</code></pre><h4 id="add-the-cert-to-ziti">Add the Cert to Ziti</h4>
<p>Open your ziti configuration file and set up the metrics api binding as shown in the <code>Authentication</code> section above. </p>
<p>Some common things to watch out for:</p>
<ul>
<li>The Ziti Controller will need to be restarted after editing the configuration file</li>
</ul>
<p>Best practices is to use a separate metrics listener that is only accessible from Prometheus.  This configuration will expose the <code>metrics/</code> on the loopback address, port 2112.</p>
<p>Add this text to the <code>web</code> section of your network controller configuration file</p>
<pre><code>  - name: metrics-localhost
    bindPoints:
      - interface: 127.0.0.1:2112
        address: 127.0.0.1:2112
    apis:
      - binding: metrics
        options: {
          scrapeCert: &quot;/path/to/prom-client.crt&quot;
        }
</code></pre><h4 id="test-the-key">Test the Key</h4>
<p>I use <code>curl</code> to test my keys when I set up metrics.  If Ziti is configured to bind metrics to <code>127.0.0.1:2112</code> then curl command will be:</p>
<pre><code>curl -i -k --cert /path/to/prom-client.crt --key /path/to/prom-client.key https://127.0.0.1:2112/metrics
</code></pre><p>The options to the curl command mean:</p>
<ul>
<li><strong>-i:</strong> Print the http status code and response headers</li>
<li><strong>-k:</strong> Ziti uses a self-signed cert, this option tells curl to ignore the server certificate</li>
<li><strong>--cert:</strong> The path to the prom-client.crt created above</li>
<li><strong>--key:</strong> The path to prom-client.key created above</li>
</ul>
<p>The result should spit out a bunch of metrics.   If you see a <code>401</code> response then double-check that you&#39;ve copied all of the bits from the certificate into the controller configuration file.</p>
<h4 id="add-the-key-to-prometheus">Add the Key to Prometheus</h4>
<p>The key is added to Promtetheus by referencing the crt and key files from the Ziti scrape configuration. </p>
<p>Your scrape config will look something like this:</p>
<pre><code>global:
  scrape_interval: 10s
  scrape_timeout: 10s

rule_files:
  - alert.yml

scrape_configs:
  - job_name: self
    metrics_path: /metrics
    static_configs:
      - targets:
        - &#39;prometheus:9090&#39;

  - job_name: ziti
    scheme: https
    metrics_path: /metrics
    honor_labels: true # Ziti supplies system labels for the edge routers, so we need to obey them
    honor_timestamps: true # Honor server timestamps instead of using the scrape timestamp for metrics
    tls_config:
      cert_file: /path/to/prom-client.crt
      key_file: /path/to/prom-client.key
      insecure_skip_verify: true
    static_configs:
      - targets:
        - &#39;127.0.0.1:2112&#39;
</code></pre></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/openziti/ziti-doc/blob/master/docfx_project/ziti/metrics/prometheus.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <span class='pull-left'><span><a href='https://netfoundry.io'>©NetFoundry Inc.</a></span>&nbsp;&nbsp;<span><a href='https://www.netfoundry.io/privacy-policy'>Privacy Policy</a></span>&nbsp;&nbsp;<span><a href='https://www.netfoundry.io/legal-items'>Legal</a></span>&nbsp;&nbsp;<span><a href='https://netfoundry.zendesk.com/hc/en-us'>Support</a></span>&nbsp;&nbsp;</span><span class='pull-right'><span><a href='https://www.facebook.com/NetFoundry/' target='_blank'><img height='25' src='/images/fb.svg'></a></span>&nbsp;<span><a href='https://twitter.com/openziti' target='_blank'><img height='25' src='/images/twit.svg'></a></span>&nbsp;<span><a href='https://www.linkedin.com/company/netfoundry/' target='_blank'><img height='25' src='/images/li.svg'></a></span>&nbsp;<span><a href='https://www.youtube.com/channel/UCAsrfQasdZmp2Gq07Ej_5cQ' target='_blank'><img height='25' src='/images/yt.svg'></a></span>&nbsp;&nbsp;&nbsp;</span><br>
<!-- Place this tag in your head or just before your close body tag. -->
<script async="" defer="" src="https://buttons.github.io/buttons.js"></script>
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
